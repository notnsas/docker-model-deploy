{% extends "base.html" %}

{% block content %}
<!-- <head>
    <link href="app/static/css/output.css" rel="stylesheet">
</head> -->
<title>Upload new File</title>
<div class="w-full mb-10 p-6 bg-indigo-50 rounded-lg shadow-xl">
  <h1 class="text-4xl font-bold text-indigo-900 mb-4 text-center">
    Dataset Table Manager
  </h1>
  <p class="text-gray-700 text-base max-w-2xl mx-auto">
    Upload, manage, dan konfigurasi table buat preprocessing dan prediksi. 
    Setiap table bisa memuat banyak DataFrames, dan bila dalam table jumlah dataset lebih dari satu harus join columns(seperti sql join)
    sebelum kombinasi ke dataset final.
  </p>
</div>

<div class="flex flex-wrap items-start justify-center gap-8 bg-slate-100 p-8 min-h-screen">

  {% if dataframes and dataframes|length > 0 %}
  {% for name, df_list in dataframes.items() %}
  {% set table_num = name | replace('table_', '') %}

  <div class="table-container max-w-md w-full bg-white shadow-xl rounded-lg overflow-hidden">

    <div class="block bg-gray-800 p-4 text-lg font-bold text-center text-white">
      <h3>Table {{ table_num }}</h3>
    </div>

    <div class="p-6 space-y-4">
      <label for="df_select_{{ table_num }}" class="block text-sm font-medium text-gray-700">DataFrames in this
        table:</label>
      <select id="df_select_{{ table_num }}" name="selected_dataframe"
        class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
        {% for i in range(df_list|length) %}
        <option value="dataframe{{ loop.index }}">DataFrame {{ loop.index }}</option>
        {% endfor %}
      </select>

      <hr class="border-gray-200">

      <form action="/" method="POST" enctype="multipart/form-data">
        <input type="hidden" name="table_num" value="{{ table_num }}">

        <strong class="block text-sm font-medium text-gray-700 mb-2">Add another DataFrame to Table {{ table_num
          }}:</strong>
        <input type="file" name="upload" onchange="this.form.submit()" class="block w-full text-sm text-gray-500
            file:mr-4 file:py-2 file:px-4
            file:rounded-full file:border-0
            file:text-sm file:font-semibold
            file:bg-indigo-50 file:text-indigo-700
            hover:file:bg-indigo-100 cursor-pointer">
      </form>
    </div>

    <form action="/" method="POST" enctype="multipart/form-data">
      <input type="hidden" name="table_num" value="{{ table_num }}">

      <hr class="border-gray-200">

      <div class="p-6 space-y-4">
        <h4 class="text-lg font-semibold text-gray-900">Join Configuration</h4>
        <p class="text-sm text-gray-600">Select a join column from each DataFrame:</p>

        {% for df in df_list %}
        <div class="join-selector flex items-center justify-between gap-4">
          <label class="text-sm font-medium text-gray-700">DataFrame {{ loop.index }}: </label>
          <select name="join_col_{{ loop.index }}"
            class="mt-1 block w-2/3 rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
            {% for col in df.columns %}
            <option value="{{ col }}">{{ col }}</option>
            {% endfor %}
          </select>
        </div>
        {% endfor %}

        <input name="submit_join" value="Set Join Columns" type="submit"
          class="w-full mt-2 inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 cursor-pointer">

        <hr class="pt-4 border-gray-200">

        <input name="delete" value="Delete Table {{ table_num }}" type="submit"
          class="w-full inline-flex justify-center py-2 px-4 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-red-700 bg-red-100 hover:bg-red-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 cursor-pointer">
      </div>
    </form>
  </div>
  {% endfor %}

  <form action="/" method="POST" enctype="multipart/form-data" class="max-w-md w-full">
    <label
      class="flex flex-col items-center justify-center w-full h-full p-6 bg-white border-2 border-dashed border-gray-300 rounded-lg shadow-xl cursor-pointer hover:bg-gray-50">
      <span class="text-indigo-600 font-semibold text-lg">+ Add New Table</span>
      <span class="text-sm text-gray-500 mt-1">Upload a file to create a new table</span>
      <input type="file" name="upload_table" onchange="this.form.submit()" class="hidden">
    </label>
  </form>

  {% else %}

  <div
    class="table-container max-w-md w-full mx-auto mt-10 bg-white shadow-lg rounded-lg overflow-hidden text-center p-10">
    <h3 class="text-xl font-semibold text-gray-900 mb-2">No tables found.</h3>
    <p class="text-sm text-gray-600 mb-6">Upload a file to create your first table.</p>
    <form action="/" method="POST" enctype="multipart/form-data">
      <input type="hidden" name="table_num" value="1">
      <label
        class="w-full inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 cursor-pointer">
        Upload First File
        <input type="file" name="upload" onchange="this.form.submit()" class="hidden">
      </label>
    </form>
  </div>
  {% endif %}

  <form action="/" method="POST" class="w-full max-w-md">
    <div>
      <input
        class="hover:shadow-lg transition-all duration-200 w-full rounded-md bg-blue-600 py-3 px-8 text-center text-base font-semibold text-white outline-none cursor-pointer hover:bg-blue-700"
        type="submit" name="upload_dataset" value="Upload Dataset">
    </div>
  </form>

</div>

<!-- </form> -->
<!-- <form class="py-4 px-6 flex-row" method=post enctype=multipart/form-data>
  <div class="rounded-md border border-indigo-500 bg-gray-50 p-4 shadow-md w-36 mb-3">
    <label for="upload" class="flex flex-col items-center gap-2 cursor-pointer">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 fill-white stroke-indigo-500" viewBox="0 0 24 24"
        stroke="currentColor" stroke-width="2">
        <path stroke-linecap="round" stroke-linejoin="round"
          d="M9 13h6m-3-3v6m5 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
      </svg>
      <span class="text-gray-600 font-medium">Upload file</span>
    </label>
    <input type="file" id="upload" name="file" class="hidden" multiple />
  </div>
  <input
    class="hover:shadow-form w-full rounded-md bg-[#6A64F1] py-3 px-8 text-center text-base font-semibold text-white outline-none"
    type=submit name="action" value=Upload>
</form> -->
</div>

<h2 class="text-center text-2xl font-bold text-gray-800 mt-4 mb-2">
    Real-Time Prediction
  </h2>
  <p class="text-center text-gray-600 mb-4">
    Masukan informasi yang diperlukan dibawah untuk mendapatkan prediksi instan.
  </p>
<div class="max-w-md mx-auto mt-10 bg-white shadow-lg rounded-lg overflow-hidden">
  <form class="py-4 px-6" action="" method="POST" id="my-form" novalidate>
    <div class="mb-4">
      <label class="block text-gray-700 font-bold mb-2">Amount: <input
          class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"
          type="number" step="0.1" name="amount" required></label><br>
    </div>
    <div class="mb-4">
      <label class="block text-gray-700 font-bold mb-2">Location:</label>
      <select
        class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"
        name="location" required>
        <option value="">Pilih lokasi</option>
        {% for loc in options %}
        <option value="{{ loc }}">{{ loc }}</option>
        {% endfor %}
      </select>
    </div>
    <!-- <div class="mb-4">
      <label class="block text-gray-700 font-bold mb-2">Petal Length: <input
          class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"
          type="number" step="0.1" name="petal_length" required></label><br>
    </div>
    <div class="mb-4">
      <label class="block text-gray-700 font-bold mb-2">Petal Width: <input
          class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"
          type="number" step="0.1" name="petal_width" required></label><br>
    </div> -->
    <div class="flex items-center justify-center mb-4">
      <button class="bg-gray-900 text-white py-2 px-4 rounded hover:bg-gray-800 focus:outline-none focus:shadow-outline"
        type="submit" name="upload_form" value="submit">Predict</button>
    </div>
</div>
</form>
<script>
  // Wait for the entire page to load
  document.addEventListener('DOMContentLoaded', () => {

    // 1. Find your form element by its ID
    const myForm = document.getElementById('my-form');

    // 2. Add an event listener for the "submit" event
    myForm.addEventListener('submit', (event) => {
      const formData = new FormData(myForm);
      // 3. IMPORTANT: Stop the form from refreshing the page
      event.preventDefault();

      // 4. Now you can get the data from the form
      const data = Object.fromEntries(formData.entries());

      console.log("Sending this data to server:", data);

      // 5. Do whatever you want with the data!
      console.log('The form was submitted!');
      // console.log('Username:', username);
      fetch('/api/prediction', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
      })
        .then(response => response.json())
        .then(result => {
          // 'result' is the JSON from Flask: {'prediction': 'setosa'}
          console.log('Server responded:', result.prediction);

          // THE FIX: Find the <p> tag and update it
          const resultElement = document.getElementById('prediction-result');
          resultElement.innerHTML = result.prediction;

        })
        .catch(error => {
          console.error('Error:', error);
          const resultElement = document.getElementById('prediction-result');
          resultElement.innerHTML = "Error during prediction.";
        });
    });
  });;
  // You could now send this data to your server using fetch()  
  // fetch('/api/your-endpoint', { method: 'POST', body: formData });



</script>
<!-- {% if pred_class %} -->
<div class="shadow-lg rounded-lg max-w-md flex items-center justify-center mx-auto mb-4 mt-5 bg-gray-900 p-2">
  <p class="shadow block text-gray-700 font-bold mb-2 text-white">Hasil prediksi adalah <span id="prediction-result"
      class="text-center bg-white text-black block rounded pd-2 ml-10 mr-10"></span></p>
</div>
<!-- {% endif %} -->

{% endblock %}